<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivid Lovely - Add Image</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        label, input, textarea, button { display: block; width: 100%; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        img { width: 50px; height: auto; }
        .actions button { margin-right: 5px; }
    </style>
</head>
<body>
    <h2>Add Image to Gallery</h2>
    <form id="uploadForm">
        <label for="token">GitHub Token:</label>
        <input type="password" id="token" placeholder="Enter GitHub Token">
        <button type="button" onclick="saveToken()">Save Token</button>

        <label for="imageFile">Upload Image:</label>
        <input type="file" id="imageFile" accept="image/*">
        
        <label for="imageName">Image Name:</label>
        <input type="text" id="imageName" required>
        
        <label for="imageBio">Bio:</label>
        <textarea id="imageBio" rows="4" required></textarea>

        <label for="imageQuote">Character Quote:</label>
        <textarea id="imageQuote" rows="2"></textarea>
        
        <label for="imageDetails">Additional Info:</label>
        <textarea id="imageDetails" rows="2"></textarea>

        <button type="button" onclick="uploadNewEntry()">Upload New Entry</button>
        
        <button type="button" onclick="updateMetadata()">Update Metadata</button>
    </form>
    
    <h2>Gallery</h2>
    <table>
        <thead>
            <tr>
                <th>Thumbnail</th>
                <th>Name</th>
                <th>Order</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="galleryTable"></tbody>
    </table>
    
    <pre id="output"></pre>
    
    <script>
        const repo = "briskartstudio/vividlovely";
        const metadataPath = "gallery/metadata.json";
        const galleryPath = "gallery/";
        const branch = "main";
        let metadata = {};
        let metadataSha = "";
        let editingFilename = null;

        function saveToken() {
            const token = document.getElementById('token').value.trim();
            if (token) {
                localStorage.setItem('githubToken', token);
                alert("Token saved locally!");
            }
        }

        function loadToken() {
            const token = localStorage.getItem('githubToken');
            if (token) {
                document.getElementById('token').value = token;
            }
        }
        
        window.onload = function() {
            loadToken();
            loadGallery();
        };

        function utf8_to_b64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function b64_to_utf8(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        async function loadGallery() {
            const token = localStorage.getItem('githubToken');
            const metadataUrl = `https://api.github.com/repos/${repo}/contents/${metadataPath}`;
            
            try {
                const response = await fetch(metadataUrl, { headers: { 'Authorization': `token ${token}` } });
                if (response.ok) {
                    const data = await response.json();
                    metadata = JSON.parse(b64_to_utf8(data.content));
                    metadataSha = data.sha;
                    
                    const table = document.getElementById('galleryTable');
                    table.innerHTML = "";
                    
                    Object.entries(metadata)
                        .sort((a, b) => b[1].order - a[1].order)
                        .forEach(([filename, item]) => {
                            const imageUrl = `https://raw.githubusercontent.com/${repo}/${branch}/${galleryPath}${filename}`;

                            const title = item.title || "";
                            const bio = item.bio || "";
                            const quote = item.quote || "";
                            const details = item.details || "";
                            const order = item.order || 0;

                            const row = `<tr>
                                <td><img src='${imageUrl}' alt='${title}'></td>
                                <td>${title}</td>
                                <td>${order}</td>
                                <td class="actions">
                                    <button onclick="editImage('${filename}', '${title}', '${bio}', '${details}', '${quote}', ${order})">Edit</button>
                                    <button onclick="replaceImage('${filename}')">Replace Image</button>
                                    <button onclick="deleteImage('${filename}')">Delete</button>
                                </td>
                            </tr>`;
                            table.innerHTML += row;
                        });
                }
            } catch (error) {
                console.warn("Failed to load gallery.", error);
            }
        }
       async function updateMetadata() {
    if (!editingFilename) {
        alert("No image selected for editing.");
        return;
    }

    const token = localStorage.getItem('githubToken');
    const newTitle = document.getElementById('imageName').value;
    const newBio = document.getElementById('imageBio').value;
    const newQuote = document.getElementById('imageQuote').value;
    const newDetails = document.getElementById('imageDetails').value;

    metadata[editingFilename] = {
        ...metadata[editingFilename],  // Keep existing metadata
        title: newTitle,
        bio: newBio,
        quote: newQuote,
        details: newDetails
    };

    const updatedMetadata = utf8_to_b64(JSON.stringify(metadata, null, 2));
    const metadataUrl = `https://api.github.com/repos/${repo}/contents/${metadataPath}`;

    try {
        const response = await fetch(metadataUrl, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "Update metadata",
                content: updatedMetadata,
                branch: branch,
                sha: metadataSha
            })
        });

        if (response.ok) {
            alert("Metadata updated successfully!");
            loadGallery();
        } else {
            alert("Failed to update metadata.");
        }
    } catch (error) {
        console.warn("Error updating metadata:", error);
    }
}
      
async function uploadNewEntry() {
    const token = localStorage.getItem('githubToken');
    const fileInput = document.getElementById('imageFile');
    const file = fileInput.files[0];

    if (!file) {
        alert("Please select an image.");
        return;
    }

    const title = document.getElementById('imageName').value.trim();
    const bio = document.getElementById('imageBio').value.trim();
    const quote = document.getElementById('imageQuote').value.trim();
    const details = document.getElementById('imageDetails').value.trim();

    if (!title || !bio) {
        alert("Please fill in the title and bio.");
        return;
    }

    // Read file and encode as Base64
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async function () {
        const base64Data = reader.result.split(',')[1];
        const filename = file.name.replace(/\s+/g, "_");
        const filePath = `${galleryPath}${filename}`;
        const uploadUrl = `https://api.github.com/repos/${repo}/contents/${filePath}`;

        try {
            // Upload image to GitHub
            const uploadResponse = await fetch(uploadUrl, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: `Uploaded ${filename}`,
                    content: base64Data,
                    branch: branch
                })
            });

            if (!uploadResponse.ok) {
                alert("Image upload failed.");
                return;
            }

            // Determine the next order number
            const orderNumbers = Object.values(metadata).map(entry => entry.order || 0);
            const newOrder = orderNumbers.length > 0 ? Math.max(...orderNumbers) + 1 : 1;

            // Add new metadata entry
            metadata[filename] = {
                title: title,
                bio: bio,
                quote: quote,
                details: details,
                order: newOrder
            };

            // Update metadata.json
            const updatedMetadata = utf8_to_b64(JSON.stringify(metadata, null, 2));
            const metadataUrl = `https://api.github.com/repos/${repo}/contents/${metadataPath}`;

            const metadataResponse = await fetch(metadataUrl, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: "Added new entry",
                    content: updatedMetadata,
                    branch: branch,
                    sha: metadataSha
                })
            });

            if (metadataResponse.ok) {
                alert("New entry uploaded successfully!");
                loadGallery(); // Refresh the gallery
            } else {
                alert("Metadata update failed.");
            }

        } catch (error) {
            console.error("Error uploading new entry:", error);
        }
    };
}
    
async function deleteImage(filename) {
    const token = localStorage.getItem('githubToken');
    const imageUrl = `https://api.github.com/repos/${repo}/contents/${galleryPath}${filename}`;

    if (!confirm(`Are you sure you want to delete ${filename}? This action cannot be undone.`)) {
        return;
    }

    try {
        // Attempt to fetch the file SHA
        const response = await fetch(imageUrl, {
            headers: { "Authorization": `token ${token}` }
        });

        let imageSha = null;

        if (response.ok) {
            const imageData = await response.json();
            imageSha = imageData.sha;
        } else if (response.status === 404) {
            console.warn("Image file not found in repository, proceeding with metadata deletion.");
        } else {
            throw new Error("Failed to fetch image data.");
        }

        // If the file exists, delete it
        if (imageSha) {
            const deleteResponse = await fetch(imageUrl, {
                method: "DELETE",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: `Delete image ${filename}`,
                    sha: imageSha,
                    branch: branch
                })
            });

            if (!deleteResponse.ok) {
                throw new Error("Failed to delete image.");
            }
        }

        // Remove the entry from metadata, even if the file is missing
        if (metadata[filename]) {
            delete metadata[filename];
            await updateMetadataFile();
        }

        alert("Image and metadata deleted successfully!");
        loadGallery();
    } catch (error) {
        console.error("Error deleting image:", error);
        alert("An error occurred while deleting the image.");
    }
}

      
async function updateMetadataFile() {
    const token = localStorage.getItem('githubToken');
    const metadataUrl = `https://api.github.com/repos/${repo}/contents/${metadataPath}`;

    try {
        const response = await fetch(metadataUrl, {
            headers: { "Authorization": `token ${token}` }
        });

        if (!response.ok) {
            throw new Error("Failed to fetch metadata.");
        }

        const data = await response.json();
        metadataSha = data.sha;

        const updatedMetadata = utf8_to_b64(JSON.stringify(metadata, null, 2));

        const updateResponse = await fetch(metadataUrl, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "Update metadata after image replacement",
                content: updatedMetadata,
                sha: metadataSha,
                branch: branch
            })
        });

        if (!updateResponse.ok) {
            throw new Error("Failed to update metadata.");
        }

        console.log("Metadata updated successfully!");
    } catch (error) {
        console.error("Error updating metadata:", error);
    }
}

      function editImage(filename, name, bio, details, quote, order) {
            document.getElementById('imageName').value = name || "";
            document.getElementById('imageBio').value = bio || "";
            document.getElementById('imageQuote').value = quote || "";  // Prevent undefined
            document.getElementById('imageDetails').value = details || "";
            editingFilename = filename;
        }


async function replaceImage(oldFilename) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const newFilename = file.name;
        const reader = new FileReader();
        reader.onload = async function() {
            const token = localStorage.getItem('githubToken');
            const oldImageUrl = `https://api.github.com/repos/${repo}/contents/${galleryPath}${oldFilename}`;
            const newImageUrl = `https://api.github.com/repos/${repo}/contents/${galleryPath}${newFilename}`;

            try {
                // Fetch the old image SHA
                const oldImageResponse = await fetch(oldImageUrl, {
                    headers: { "Authorization": `token ${token}` }
                });

                let oldSha = null;
                if (oldImageResponse.ok) {
                    const oldImageData = await oldImageResponse.json();
                    oldSha = oldImageData.sha;
                } else if (oldImageResponse.status !== 404) {
                    alert("Error fetching existing image data.");
                    return;
                }

                // Convert the image file to Base64 properly
                const binary = new Uint8Array(reader.result);
                let binaryString = "";
                for (let i = 0; i < binary.length; i++) {
                    binaryString += String.fromCharCode(binary[i]);
                }
                const content = btoa(binaryString); // Encode correctly

                // Upload new image
                const newImageResponse = await fetch(newImageUrl, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: `Upload new image ${newFilename}`,
                        content: content,
                        branch: branch
                    })
                });

                if (!newImageResponse.ok) {
                    alert("Failed to upload new image.");
                    return;
                }

                // Delete old image if it exists
                if (oldSha) {
                    await fetch(oldImageUrl, {
                        method: "DELETE",
                        headers: {
                            "Authorization": `token ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            message: `Delete old image ${oldFilename}`,
                            sha: oldSha,
                            branch: branch
                        })
                    });
                }

                // Update metadata
                if (metadata[oldFilename]) {
                    metadata[newFilename] = { ...metadata[oldFilename] }; // Copy metadata
                    delete metadata[oldFilename]; // Remove old entry
                    await updateMetadataFile();
                }

                alert("Image replaced successfully!");
                loadGallery();
            } catch (error) {
                console.error("Error replacing image:", error);
                alert("An error occurred while replacing the image.");
            }
        };

        reader.readAsArrayBuffer(file); // Read as raw binary instead of Data URL
    };
    input.click();
}


    </script>
</body>
</html>
