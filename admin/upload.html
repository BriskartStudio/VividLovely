<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivid Lovely - Add Image</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        label, input, textarea, button { display: block; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>Add Image to Gallery</h2>
    <form id="uploadForm">
        <label for="token">GitHub Token:</label>
        <input type="password" id="token" placeholder="Enter GitHub Token">
        <button type="button" onclick="saveToken()">Save Token</button>

        <label for="imageFile">Upload Image:</label>
        <input type="file" id="imageFile" accept="image/*">
        
        <label for="imageName">Image Name:</label>
        <input type="text" id="imageName" required>
        
        <label for="imageBio">Bio:</label>
        <textarea id="imageBio" rows="4" required></textarea>
        
        <label for="imageDetails">Additional Info:</label>
        <textarea id="imageDetails" rows="2"></textarea>
        
        <button type="button" onclick="uploadImage()">Upload & Update Metadata</button>
    </form>
    
    <pre id="output"></pre>
    
    <script>
        const repo = "briskartstudio/vividlovely";
        const metadataPath = "metadata.json";
        const galleryPath = "gallery/";
        const branch = "main";

        function saveToken() {
            const token = document.getElementById('token').value.trim();
            if (token) {
                localStorage.setItem('githubToken', token);
                alert("Token saved locally!");
            }
        }

        function loadToken() {
            const token = localStorage.getItem('githubToken');
            if (token) {
                document.getElementById('token').value = token;
            }
        }
        
        window.onload = loadToken;

        function utf8_to_b64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function b64_to_utf8(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        async function uploadImage() {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                alert("Please enter and save your GitHub token first.");
                return;
            }
            
            const imageFile = document.getElementById('imageFile').files[0];
            if (!imageFile) {
                alert("Please select an image.");
                return;
            }
            
            const imageName = document.getElementById('imageName').value.trim();
            const imageBio = document.getElementById('imageBio').value.trim();
            const imageDetails = document.getElementById('imageDetails').value.trim();
            
            if (!imageName) {
                alert("Please provide an image name.");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function () {
                const base64Image = reader.result.split(',')[1];
                const imagePath = `${galleryPath}${imageFile.name}`;
                
                await commitFile(imagePath, base64Image, token, `Added ${imageFile.name} to gallery`, false);
                await updateMetadata(imageFile.name, imageName, imageBio, imageDetails, token);
            };
            reader.readAsDataURL(imageFile);
        }

        async function updateMetadata(filename, name, bio, details, token) {
            const metadataUrl = `https://api.github.com/repos/${repo}/contents/${metadataPath}`;
            let metadata = [];
            let sha = null;
            
            try {
                const response = await fetch(metadataUrl, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    sha = data.sha;
                    const content = b64_to_utf8(data.content || "");
                    metadata = JSON.parse(content || "[]");
                }
            } catch (error) {
                console.warn("metadata.json not found. Creating a new one.");
            }
            
            metadata.push({ "name": name, "bio": bio, "details": details, "filename": filename });
            
            const updatedContent = utf8_to_b64(JSON.stringify(metadata, null, 4));
            
            await commitFile(metadataPath, updatedContent, token, `Updated metadata.json with ${name}`, sha);
        }

        async function commitFile(path, content, token, message, sha = null) {
            const url = `https://api.github.com/repos/${repo}/contents/${path}`;
            
            const commitData = {
                message: message,
                content: content,
                branch: branch
            };
            
            if (sha) {
                commitData.sha = sha;
            }
            
            const response = await fetch(url, {
                method: "PUT",
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(commitData)
            });
            
            if (response.ok) {
                alert("Upload successful!");
            } else {
                alert("Upload failed. Check console for details.");
                console.error(await response.json());
            }
        }
    </script>
</body>
</html>
