<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivid Lovely - Add Image</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        label, input, textarea, button { display: block; width: 100%; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        img { width: 50px; height: auto; }
        .actions button { margin-right: 5px; }
    </style>
</head>
<body>
    <h2>Add Image to Gallery</h2>
    <form id="uploadForm">
        <label for="token">GitHub Token:</label>
        <input type="password" id="token" placeholder="Enter GitHub Token">
        <button type="button" onclick="saveToken()">Save Token</button>

        <label for="imageFile">Upload Image:</label>
        <input type="file" id="imageFile" accept="image/*">
        
        <label for="imageName">Image Name:</label>
        <input type="text" id="imageName" required>
        
        <label for="imageBio">Bio:</label>
        <textarea id="imageBio" rows="4" required></textarea>
        
        <label for="imageDetails">Additional Info:</label>
        <textarea id="imageDetails" rows="2"></textarea>
        
        <button type="button" onclick="uploadImage()">Upload & Update Metadata</button>
    </form>
    
    <h2>Gallery</h2>
    <table>
        <thead>
            <tr>
                <th>Thumbnail</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="galleryTable"></tbody>
    </table>
    
    <pre id="output"></pre>
    
    <script>
        const repo = "briskartstudio/vividlovely";
        const metadataPath = "gallery/metadata.json";
        const galleryPath = "gallery/";
        const branch = "main";

        function saveToken() {
            const token = document.getElementById('token').value.trim();
            if (token) {
                localStorage.setItem('githubToken', token);
                alert("Token saved locally!");
            }
        }

        function loadToken() {
            const token = localStorage.getItem('githubToken');
            if (token) {
                document.getElementById('token').value = token;
            }
        }
        
        window.onload = function() {
            loadToken();
            loadGallery();
        };

        function utf8_to_b64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function b64_to_utf8(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        async function uploadImage() {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                alert("Please enter and save your GitHub token first.");
                return;
            }
            
            const imageFile = document.getElementById('imageFile').files[0];
            if (!imageFile) {
                alert("Please select an image.");
                return;
            }
            
            const imageName = document.getElementById('imageName').value.trim();
            const imageBio = document.getElementById('imageBio').value.trim();
            const imageDetails = document.getElementById('imageDetails').value.trim();
            
            if (!imageName) {
                alert("Please provide an image name.");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function () {
                const base64Image = reader.result.split(',')[1];
                const imagePath = `${galleryPath}${imageFile.name}`;
                
                await commitFile(imagePath, base64Image, token, `Added ${imageFile.name} to gallery`, false);
                await updateMetadata(imageFile.name, imageName, imageBio, imageDetails, token);
                loadGallery();
            };
            reader.readAsDataURL(imageFile);
        }

        async function loadGallery() {
            const token = localStorage.getItem('githubToken');
            const metadataUrl = `https://api.github.com/repos/${repo}/contents/${metadataPath}`;
            
            try {
                const response = await fetch(metadataUrl, { headers: { 'Authorization': `token ${token}` } });
                if (response.ok) {
                    const data = await response.json();
                    const metadata = JSON.parse(b64_to_utf8(data.content));
                    
                    const table = document.getElementById('galleryTable');
                    table.innerHTML = "";
                    
                    Object.entries(metadata).forEach(([filename, item]) => {
                        const row = `<tr>
                            <td>${item.title}</td>
                            <td class="actions">
                                <button onclick="editImage('${filename}', '${item.title}', '${item.bio}', '${item.details}')">Edit</button>
                                <button onclick="deleteImage('${filename}')">Delete</button>
                            </td>
                        </tr>`;
                        table.innerHTML += row;
                    });
                }
            } catch (error) {
                console.warn("Failed to load gallery.", error);
            }
        }

        function editImage(filename, name, bio, details) {
            document.getElementById('imageName').value = name;
            document.getElementById('imageBio').value = bio;
            document.getElementById('imageDetails').value = details;
        }

        async function deleteImage(filename) {
            const token = localStorage.getItem('githubToken');
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
            
            const imagePath = `${galleryPath}${filename}`;
            const metadataUrl = `https://api.github.com/repos/${repo}/contents/${metadataPath}`;
            
            try {
                await fetch(`https://api.github.com/repos/${repo}/contents/${imagePath}`, {
                    method: "DELETE",
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Deleted ${filename}`, sha: filename })
                });
                alert(`${filename} deleted.`);
                loadGallery();
            } catch (error) {
                console.error("Error deleting image:", error);
            }
        }
    </script>
</body>
</html>
